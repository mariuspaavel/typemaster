CREATE OR REPLACE FUNCTION register(
	asessionid INTEGER
)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
	aemail VARCHAR(50);
	apassword VARCHAR(32);
	hash VARCHAR(32);
	aaccountid INTEGER;	

BEGIN
	IF EXISTS (SELECT 1 FROM accounts WHERE email=aemail) THEN
		RAISE 'Email occupied' USING ERRCODE='email_occupied';
	END IF;
	SELECT email, password INTO aemail, apassword FROM regforms WHERE sessionid=asessionid;	
	hash := MD5(apassword);
	INSERT INTO accounts(email, pwhash) VALUES (aemail, hash) RETURNING accountid INTO aaccountid;
	DELETE FROM regforms WHERE sessionid = asessionid;
	RETURN aaccountid;
END; $$;
